# Score Predictor API Documentation for Flutter App

## Base URL
```
http://your-domain.com/api/
```

## Authentication
All API endpoints require authentication via phone number and PIN. The app should store the user session after successful login.

## API Endpoints

### 1. Authentication

#### Register User
```http
POST /auth/register
```

**Request Body:**
```json
{
    "full_name": "John Doe",
    "phone": "1234567890",
    "pin": "1234"
}
```

**Response:**
```json
{
    "status": "success",
    "message": "User registered successfully",
    "data": {
        "user_id": 1,
        "full_name": "John Doe",
        "phone": "1234567890"
    }
}
```

#### Login User
```http
POST /auth/login
```

**Request Body:**
```json
{
    "phone": "1234567890",
    "pin": "1234"
}
```

**Response:**
```json
{
    "status": "success",
    "message": "Login successful",
    "data": {
        "user_id": 1,
        "full_name": "John Doe",
        "phone": "1234567890"
    }
}
```

#### Get User Profile
```http
GET /auth/profile/{user_id}
```

**Response:**
```json
{
    "status": "success",
    "data": {
        "id": 1,
        "full_name": "John Doe",
        "phone": "1234567890",
        "created_at": "2024-01-01 10:00:00"
    }
}
```

#### Update User Profile
```http
PUT /auth/profile/{user_id}
```

**Request Body:**
```json
{
    "full_name": "John Updated Doe"
}
```

### 2. Stacks

#### Get All Stacks
```http
GET /stacks
```

**Response:**
```json
{
    "status": "success",
    "data": [
        {
            "id": 1,
            "title": "Premier League Weekend",
            "prize_description": "Win $1000 for perfect predictions",
            "entry_fee": "5.00",
            "deadline": "2024-01-15 19:00:00",
            "is_active": true,
            "matches": [
                {
                    "match_id": "PL001",
                    "home_team": "Manchester United",
                    "away_team": "Liverpool",
                    "match_time": "2024-01-15 20:00:00"
                }
            ]
        }
    ]
}
```

#### Get Stack Details
```http
GET /stacks/{stack_id}
```

**Response:**
```json
{
    "status": "success",
    "data": {
        "id": 1,
        "title": "Premier League Weekend",
        "prize_description": "Win $1000 for perfect predictions",
        "entry_fee": "5.00",
        "deadline": "2024-01-15 19:00:00",
        "is_active": true,
        "matches": [...],
        "participant_count": 25
    }
}
```

#### Get Stack with User Status
```http
GET /stacks/{stack_id}/user/{user_id}
```

**Response:**
```json
{
    "status": "success",
    "data": {
        "stack": {...},
        "user_status": {
            "has_paid": true,
            "has_predicted": false,
            "prediction": null,
            "score": null
        }
    }
}
```

#### Get User's Stacks
```http
GET /stacks/user/{user_id}
```

### 3. Predictions

#### Submit Prediction
```http
POST /predictions/submit
```

**Request Body:**
```json
{
    "user_id": 1,
    "stack_id": 1,
    "predictions": [
        {
            "match_id": "PL001",
            "home_score": 2,
            "away_score": 1
        },
        {
            "match_id": "PL002",
            "home_score": 0,
            "away_score": 0
        }
    ]
}
```

**Response:**
```json
{
    "status": "success",
    "message": "Prediction submitted successfully",
    "data": {
        "prediction_id": 1
    }
}
```

#### Get User's Prediction for Stack
```http
GET /predictions/user/{user_id}/stack/{stack_id}
```

#### Get All Predictions for Stack
```http
GET /predictions/stack/{stack_id}
```

#### Get User's All Predictions
```http
GET /predictions/user/{user_id}
```

### 4. Payments

#### Initialize Payment (GMPay Integration)
```http
POST /payments/initialize
```

**Request Body:**
```json
{
    "user_id": 1,
    "stack_id": 1
}
```

**Response:**
```json
{
    "status": "success",
    "message": "Payment initialized successfully",
    "data": {
        "payment_id": 1,
        "transaction_id": "20240101120000123",
        "amount": "5.00",
        "stack_title": "Premier League Weekend",
        "gmpay_payload": {
            "msisdn": "256705721545",
            "amount": "5.00",
            "transactionId": "20240101120000123"
        },
        "gmpay_url": "https://debit.gmpayapp.site/public/deposit/custom"
    }
}
```

**GMPay Integration:**
1. Use the `gmpay_payload` to make a POST request to `gmpay_url`
2. The `transactionId` is a 13-digit numeric ID generated by the system
3. Use the user's phone number as `msisdn`
4. Use the stack's entry fee as `amount`

#### Verify Payment
```http
GET /payments/verify/{transaction_id}
```

**Response:**
```json
{
    "status": "success",
    "data": {
        "transaction_id": "20240101120000123",
        "status": "SUCCESS",
        "amount": "5.00",
        "paid_at": "2024-01-01 12:00:00",
        "gmpay_status": "SUCCESS"
    }
}
```

**Status Values:**
- `SUCCESS` - Payment completed successfully
- `FAILED` - Payment failed
- `PENDING` - Payment is still processing

#### Check Payment Status
```http
GET /payments/check/{user_id}/{stack_id}
```

#### Get User's Payments
```http
GET /payments/user/{user_id}
```

#### GMPay Webhook (For Payment Gateway)
```http
POST /payments/gmpay-webhook
```

**Webhook Payload (from GMPay):**
```json
{
    "status": "success",
    "transaction": {
        "id": "380",
        "msisdn": "256741837096",
        "amount": "35000.00",
        "transaction_id": "1753220101026",
        "reference": "10fdbc4c-43d9-468e-822f-27dd1145f2f3",
        "status": "SUCCESS",
        "created_at": "2025-07-23 00:35:00"
    }
}
```

**Response:**
```json
{
    "status": "success",
    "message": "Payment status updated via webhook",
    "data": {
        "transaction_id": "1753220101026",
        "status": "SUCCESS"
    }
}
```

#### Get Stack's Payments
```http
GET /payments/stack/{stack_id}
```

### 5. Scores & Leaderboards

#### Get Stack Leaderboard
```http
GET /scores/leaderboard/{stack_id}
```

**Response:**
```json
{
    "status": "success",
    "data": [
        {
            "rank": 1,
            "user_id": 1,
            "full_name": "John Doe",
            "phone": "1234567890",
            "exact_count": 3,
            "outcome_count": 2,
            "wrong_count": 0,
            "total_points": 11
        }
    ]
}
```

#### Get User's Score for Stack
```http
GET /scores/user/{user_id}/stack/{stack_id}
```

#### Get User's Ranking
```http
GET /scores/ranking/{user_id}/{stack_id}
```

#### Get User's Statistics
```http
GET /scores/stats/{user_id}
```

#### Get Winners for Stack
```http
GET /scores/winners/{stack_id}
```

### 6. Admin Endpoints (Optional for Flutter)

#### Calculate Scores for Stack
```http
POST /scores/calculate/{stack_id}
```

**Request Body:**
```json
{
    "actual_scores": [
        {
            "match_id": "PL001",
            "home_score": 2,
            "away_score": 1
        }
    ]
}
```

#### Award Winners
```http
POST /scores/award-winners/{stack_id}
```

## Error Responses

All endpoints return consistent error responses:

```json
{
    "status": "error",
    "message": "Error description",
    "errors": {
        "field_name": ["Validation error message"]
    }
}
```

## Common HTTP Status Codes

- `200` - Success
- `201` - Created
- `400` - Bad Request
- `401` - Unauthorized
- `404` - Not Found
- `422` - Validation Error
- `500` - Server Error

## Flutter Integration Tips

### 1. HTTP Client Setup
```dart
import 'package:http/http.dart' as http;
import 'dart:convert';

class ApiService {
  static const String baseUrl = 'http://your-domain.com/api';
  
  static Future<Map<String, dynamic>> post(String endpoint, Map<String, dynamic> data) async {
    final response = await http.post(
      Uri.parse('$baseUrl$endpoint'),
      headers: {'Content-Type': 'application/json'},
      body: json.encode(data),
    );
    
    return json.decode(response.body);
  }
  
  static Future<Map<String, dynamic>> get(String endpoint) async {
    final response = await http.get(Uri.parse('$baseUrl$endpoint'));
    return json.decode(response.body);
  }
}
```

### 2. User Session Management
```dart
class UserSession {
  static int? userId;
  static String? userPhone;
  static String? userName;
  
  static void setSession(Map<String, dynamic> userData) {
    userId = userData['user_id'];
    userPhone = userData['phone'];
    userName = userData['full_name'];
  }
  
  static void clearSession() {
    userId = null;
    userPhone = null;
    userName = null;
  }
}
```

### 3. API Response Models
```dart
class ApiResponse<T> {
  final String status;
  final String message;
  final T? data;
  final Map<String, dynamic>? errors;
  
  ApiResponse({
    required this.status,
    required this.message,
    this.data,
    this.errors,
  });
  
  factory ApiResponse.fromJson(Map<String, dynamic> json) {
    return ApiResponse(
      status: json['status'],
      message: json['message'],
      data: json['data'],
      errors: json['errors'],
    );
  }
}
```

### 4. Data Models
```dart
class Stack {
  final int id;
  final String title;
  final String prizeDescription;
  final double entryFee;
  final DateTime deadline;
  final bool isActive;
  final List<Match> matches;
  final int participantCount;
  
  Stack({
    required this.id,
    required this.title,
    required this.prizeDescription,
    required this.entryFee,
    required this.deadline,
    required this.isActive,
    required this.matches,
    required this.participantCount,
  });
  
  factory Stack.fromJson(Map<String, dynamic> json) {
    return Stack(
      id: json['id'],
      title: json['title'],
      prizeDescription: json['prize_description'],
      entryFee: double.parse(json['entry_fee']),
      deadline: DateTime.parse(json['deadline']),
      isActive: json['is_active'],
      matches: (json['matches'] as List).map((m) => Match.fromJson(m)).toList(),
      participantCount: json['participant_count'] ?? 0,
    );
  }
}

class GMPayPayment {
  final String msisdn;
  final String amount;
  final String transactionId;
  
  GMPayPayment({
    required this.msisdn,
    required this.amount,
    required this.transactionId,
  });
  
  Map<String, dynamic> toJson() {
    return {
      'msisdn': msisdn,
      'amount': amount,
      'transactionId': transactionId,
    };
  }
}
```

class Match {
  final String matchId;
  final String homeTeam;
  final String awayTeam;
  final DateTime matchTime;
  
  Match({
    required this.matchId,
    required this.homeTeam,
    required this.awayTeam,
    required this.matchTime,
  });
  
  factory Match.fromJson(Map<String, dynamic> json) {
    return Match(
      matchId: json['match_id'],
      homeTeam: json['home_team'],
      awayTeam: json['away_team'],
      matchTime: DateTime.parse(json['match_time']),
    );
  }
}
```

## Testing the API

You can test all endpoints using tools like:
- Postman
- Insomnia
- curl commands

Example curl command:
```bash
curl -X POST http://your-domain.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"1234567890","pin":"1234"}'
```

## GMPay Integration Example

### Flutter Implementation
```dart
class GMPayService {
  static const String gmpayUrl = 'https://debit.gmpayapp.site/public/deposit/custom';
  
  static Future<Map<String, dynamic>> processPayment(GMPayPayment payment) async {
    try {
      final response = await http.post(
        Uri.parse(gmpayUrl),
        headers: {'Content-Type': 'application/json'},
        body: json.encode(payment.toJson()),
      );
      
      return json.decode(response.body);
    } catch (e) {
      throw Exception('Payment processing failed: $e');
    }
  }
  
  static Future<String> checkTransactionStatus(String transactionId) async {
    try {
      final response = await http.get(
        Uri.parse('https://debit.gmpayapp.site/public/transaction-status/$transactionId'),
      );
      
      final data = json.decode(response.body);
      if (data['status'] == 'success') {
        return data['transaction']['status'];
      }
      return 'PENDING';
    } catch (e) {
      return 'PENDING';
    }
  }
}

// Usage in Flutter app
Future<void> makePayment(int userId, int stackId) async {
  // 1. Initialize payment with our API
  final initResponse = await ApiService.post('/payments/initialize', {
    'user_id': userId,
    'stack_id': stackId,
  });
  
  if (initResponse['status'] == 'success') {
    final data = initResponse['data'];
    final gmpayPayload = data['gmpay_payload'];
    
    // 2. Process payment with GMPay
    final gmpayResponse = await GMPayService.processPayment(
      GMPayPayment(
        msisdn: gmpayPayload['msisdn'],
        amount: gmpayPayload['amount'],
        transactionId: gmpayPayload['transactionId'],
      ),
    );
    
    // 3. Check payment status
    String status = await GMPayService.checkTransactionStatus(
      gmpayPayload['transactionId'],
    );
    
    // 4. Verify with our API
    final verifyResponse = await ApiService.get(
      '/payments/verify/${gmpayPayload['transactionId']}',
    );
    
    print('Payment status: ${verifyResponse['data']['status']}');
  }
}
```

## Security Considerations

1. **HTTPS**: Always use HTTPS in production
2. **Input Validation**: All inputs are validated server-side
3. **Rate Limiting**: Implement rate limiting for API endpoints
4. **Session Management**: Store user sessions securely
5. **Error Handling**: Don't expose sensitive information in error messages

## Performance Tips

1. **Caching**: Cache frequently accessed data like stacks and leaderboards
2. **Pagination**: Implement pagination for large datasets
3. **Image Optimization**: Optimize images before uploading
4. **API Versioning**: Use versioning for future API changes

This API is designed to be RESTful and follows best practices for mobile app integration. All endpoints are optimized for Flutter app consumption with proper error handling and response formatting. 